# Maddy configuration for Newsletter Platform
# This file is templated during installation

# Global configuration
$(hostname) = {env.MADDY_HOSTNAME}
$(primary_domain) = {env.SENDING_DOMAIN}

# TLS configuration
tls file /etc/maddy/keys/tls.crt /etc/maddy/keys/tls.key

# SMTP submission (port 587)
submission tcp://0.0.0.0:587 {
    auth <local_auth>
    source <local_rewrite>
    destination <local_delivery>
    deliver_to <queue>
}

# SMTP relay (port 25)
smtp tcp://0.0.0.0:25 {
    source <remote_rewrite>
    destination <remote_delivery>
    deliver_to <queue>
}

# Local authentication (for app submissions)
auth.pass_table local_auth {
    table sql_table {
        driver sqlite3
        dsn /var/app/auth.db
        table auth_users
        columns username, password_hash
    }
}

# Local rewrite (for outbound emails)
rewrite <local_rewrite> {
    to {env.SENDING_DOMAIN}
}

# Remote rewrite (for incoming emails)
rewrite <remote_rewrite> {
    to {env.SENDING_DOMAIN}
}

# Local delivery (bounces, etc.)
delivery <local_delivery> {
    destination {env.SENDING_DOMAIN} {
        deliver_to <bounce_handler>
    }
}

# Remote delivery (outbound emails)
delivery <remote_delivery> {
    destination * {
        deliver_to <remote_queue>
    }
}

# Bounce handler (processes bounces)
target <bounce_handler> {
    pipe {
        command /usr/local/bin/bounce-processor
        args --webhook-url http://app:8080/api/hooks/bounce
    }
}

# Remote queue (sends emails to external servers)
target <remote_queue> {
    smtp tcp://[${env.SMTP_RELAY_HOST}:${env.SMTP_RELAY_PORT}] {
        auth <remote_auth>
        tls &tls
    }
}

# Remote authentication (if using relay)
auth.plain remote_auth {
    username {env.SMTP_RELAY_USERNAME}
    password {env.SMTP_RELAY_PASSWORD}
}

# Queue for outbound emails
queue <queue> {
    target <remote_queue>
    target <bounce_handler>
}

# DKIM signing
modify {
    dkim {
        sign_networks 0.0.0.0/0
        key_file /etc/maddy/keys/dkim.key
        selector {env.DKIM_SELECTOR}
        domain {env.SENDING_DOMAIN}
    }
}

# Rate limiting
rate_limit {
    connections 100
    messages 1000
    size 10MB
}

# Logging
log {
    level info
    syslog
}
